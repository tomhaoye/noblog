---
title: HybridApp历险记
date: 2019-01-27 15:46:30
tags: Hybird
categories: 挖坑
---
>Listen to the pain, it's both history teacher and fortune teller. Pain teaches us who we are, Wade. Sometimes it's so bad you feel like you're dying but we can't really live until we die a little, can we?

最近项目里面使用`Cordova`进行`Hybrid App`的开发，实际上我们是有一些类似于淘票票出票机那样的机器，需要一款能够在该机器的系统（安卓）中运行并调用硬件实现扫码出票等功能的安卓应用。我负责的是工作内容主要是接入供应商所提供的硬件`SDK`，并转化为可被`Javascript`调用的插件。

如何开发`Cordova`安卓插件，官网和谷歌有很多教程，没必要在这里复制粘贴一遍，写这篇文章的主要目的是分享在项目中遇到问题时的一些解决思路，以及这次仓促的完成任务之后的一些感想。

原本以为这次开发完全是`Web App`，我就是写一下`Java`代码作为插件让前端去调用，到后面发现打票器的排版功能刚好完全不符合我们的需求，由于时间紧迫，换机器是不可能的了，迫不得已我们决定使用打票机打印图片的功能，我们在图片里面对内容排版好，然后使用打票机进行打印出票。虽然这样会存在一些问题，例如比较小的字会不太清晰，但是这却是看起来最方便也是当前唯一的解决方案了。然而接入扫码器的`SDK`的时候才意识到，坑总是无处不在的。当然也不能全怪设备供应商，因为他们不清楚我们开发的是`Web App`，而扫码器的最大问题就在于，供应商提供的`SDK`并不是跟扫码设备交互的并返回结果的，扫码器本身就自带扫码识别功能，并且在识别之后自动通过`USB`对系统进行键入，所以`SDK`它仅仅只充当了一个拦截外部`USB`键盘设备键入并组装的角色。而`Cordova`插件这一层是无法对键盘输入进行监听的，所以这个`SDK`对我们来说完全是没用的。随后我想让前端想办法使用`Javascript`对键盘输入进行拦截并对所有内容进行组装，然而经过一轮查阅资料和实践后前端同事告诉我在他在安卓浏览器里面无法获取到键入的`KeyCode`，这。。。

虽然心里的羊驼真的无法言表，但是问题总是要解决的。与其埋怨，还不如动脑筋想一想解决办法。经过大家对扫码器的反复研究，初步制订了两个解决方案。

 - 方案一：通过按钮定位到一个隐藏的`input`框获得焦点，然后扫描二维码后内容就会被填充到`input`框内，然后再将获取得到的内容去请求接口得到图片地址再调用打印插件进行打印。
 - 方案二：通过按钮触发跳转到原生安卓界面，在安卓页面内进行键入拦截，然后同样的将二维码内容去请求接口得到图片地址再调用打印插件进行打印，打印完毕后跳转回原`WebView`页面。

实际上我们在操作方案一的时候遇到了非常多的问题，例如`input`框获得焦点会使得系统软键盘弹起，又例如键入的时候若软键盘的语言是中文的话，那么键入的内容就会出问题。因此方案一实在是不靠谱的方案，很快就被否决了。

于是我们很快就决定实践方案二了，虽然我大学是学`Java`入门的，但是对安卓完全不熟悉，现在才找人来接手也不太现实。所以也只能硬着头皮上了，毕竟需要做的只是一个简单的页面，应该没多困难。整个方案二实现过程大都非常顺利，包括原生页面与到`WebView`页面相互跳转、接入扫码器的`SDK`、调用出票机的`SDK`，这几个流程的代码没有出现任何问题，整个过程大家调试起来都比较轻松愉快。然而暴风雨来临之前总是宁静的，不知道大家是否还记得我们扫码获得的数据是需要通过接口再去换取图片地址然后才能进行打印的，其实最大的问题就埋藏在了这里。

我们最后将接口接入，并调用之前给`Js`调用的插件，然而发现程序并不能正常运作。随后我们将插件部分的代码单独拿出来执行，才找到了问题出在了网请求上面，因为网络请求在主线程上面执行是会抛出异常的。所以在查阅资料之后，我们尝试了另起线程进行网络处理，然而也没有成功。我承认当时是的氛围是急躁的，因为大家已经加班快十个小时了，却卡在最后这一步，而大佬们给的建议是使用网络请求库。我们都清楚使用库是需要不少时间成本去看文档的，所以大家的情绪都比较的消极。但我也没用纠结于刚刚的代码为何不能正常运行，而是决定静下心来好好看一下大家介绍的网络请求库，最终使用了`async-http-client`，虽然说这个库不建议安卓2.2之后版本使用，但是由于有一份乙方公司的代码也使用了这个库，我们起码可以有个比较靠谱的参考，对比起在搜索引擎的条目里进行筛选，我想这份能在真机上运行的代码还是个比较好的选择。

很快，我们临摹着乙方的代码，写出了我们的自己的网络请求，然后再写上了一堆签名的算法，终于，接口请求成功了，图片的地址我们获取回来了。然而，一波刚平一波又起。是的，我们还需要另外一个网络请求进行图片下载。我们在异步请求成功后再对图片资源进行请求，结果这时候发现无论是进行同步还是异步的网络请求，程序都会闪退。由于经验缺乏，我们到最后都没有找到原因，无奈之下，我们选择了修改接口，将原来返回图片地址改为了返回图片的`base64`数据。这并不是理想的解决方案，因为这样无疑是给我们的接口服务带宽带增加了不少压力。虽然对于我们来说肯定是心有不甘，但至少下一个工作日我们可以及时向客户展示`demo`了，之后的优化我们就需要专业的安卓工程师来介入了。

我很庆幸这一次的任务能够按时完成，说实话，在接受这项任务的时候我心里并没有十足的把握，也欠缺了自己的思考，结果在实现的过程中不断的遇到了各种难题，这让我想起了`The Clean Code`其中一章，关于学会说“不”的重要性。可能大家会觉得说“不”就是承认自己能力不足，说“不”就是不肯为公司为团队付出努力，说“不”就是不专业的表现。但是事实却恰恰相反，说“不”是我最专业的回答，因为我绝不会让公司和客户去承担所谓的“试一试”或者“我尽力”所带来失败的结果。我说“不”是提前让领导和公司清楚在限定的时间和指定的技术范畴内我并不能胜任这一次的任务，当然，领导可能会用各种方式诱导我接受这项任务，但是专业的程序员就要坚守自己的底线。我们都知道任何功能的解决方案都不止一个，同样的，我们的领导也有足够的资源让他们能够找到更加合适更加专业的人员去接手任务。只有准时交付以及高质量的软件才能够使得公司和客户双赢，如果你心里没有底，请务必说“不”。
